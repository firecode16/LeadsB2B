{
  "name": "Leads B2B â€” Salud Mental CDMX (Multi-OS)",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-manual",
      "name": "â–¶ï¸ Inicio Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "weeksInterval": 1,
              "triggerAtDay": [1],
              "triggerAtHour": 6,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "id": "trigger-schedule",
      "name": "â° Schedule Semanal (Lunes 6am)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 560]
    },
    {
      "parameters": {
        "command": "python {{ $env.SCRIPTS_DIR }}/extractor_hibrido.py --max 200 --output leads_raw.json 2>&1"
      },
      "id": "script1-extractor",
      "name": "ğŸ“œ Script 1 â€” Extractor de Leads",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [520, 480],
      "notesInFlow": true,
      "notes": "Extrae leads desde Doctoralia.\nGenera: leads_raw.json\nRequiere variable SCRIPTS_DIR."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-exit-code",
              "leftValue": "={{ $json.exitCode }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-script1",
      "name": "âœ… Â¿Script 1 OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [760, 480]
    },
    {
      "parameters": {
        "command": "python {{ $env.SCRIPTS_DIR }}/verificar_whatsapp.py --input leads_raw.json --output leads_verificados.json --max-hora 40 2>&1"
      },
      "id": "script2-verificador",
      "name": "ğŸ“œ Script 2 â€” Verificador WhatsApp",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1020, 400],
      "notesInFlow": true,
      "notes": "Verifica nÃºmeros en WhatsApp Web.\nGenera: leads_verificados.json\nâš ï¸ Puede tardar horas con 200+ leads."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-exit-code-2",
              "leftValue": "={{ $json.exitCode }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-script2",
      "name": "âœ… Â¿Script 2 OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1260, 400]
    },
    {
      "parameters": {
        "command": "python {{ $env.SCRIPTS_DIR }}/setup_postgresql.py importar --input leads_verificados.json --nicho salud_mental --expo \"={{ $now.format('yyyy-MM') }}\" 2>&1"
      },
      "id": "script3-importar",
      "name": "ğŸ“œ Script 3 â€” Importar a PostgreSQL",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1500, 320],
      "notesInFlow": true,
      "notes": "Upsert de leads verificados en BD.\nExpo ID = mes actual (ej. 2026-02)"
    },
    {
      "parameters": {
        "command": "python {{ $env.SCRIPTS_DIR }}/setup_postgresql.py exportar --output {{ $env.EXPORTS_DIR }}/leads_crm.csv 2>&1"
      },
      "id": "script3-exportar",
      "name": "ğŸ“œ Script 3 â€” Exportar CSV",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1740, 320],
      "notesInFlow": true,
      "notes": "Genera CSV con leads WhatsApp vÃ¡lidos.\nGuardado en {{ $env.EXPORTS_DIR }}/leads_crm.csv"
    },
    {
      "parameters": {
        "command": "python {{ $env.SCRIPTS_DIR }}/setup_postgresql.py stats 2>&1"
      },
      "id": "script3-stats",
      "name": "ğŸ“Š Script 3 â€” Stats de BD",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1980, 320]
    },
    {
      "parameters": {
        "jsCode": "// Parsear el output de stats y construir resumen para notificaciÃ³n\nconst stdout = $input.first().json.stdout || '';\n\n// Extraer mÃ©tricas con regex\nconst totalMatch    = stdout.match(/Total leads\\s+:\\s*(\\d+)/);\nconst validosMatch  = stdout.match(/WhatsApp vÃ¡lidos\\s+:\\s*(\\d+)\\s+\\((\\d+)%\\)/);\nconst emailMatch    = stdout.match(/Con email\\s+:\\s*(\\d+)/);\n\nconst total   = totalMatch   ? parseInt(totalMatch[1])   : 0;\nconst validos = validosMatch ? parseInt(validosMatch[1]) : 0;\nconst pct     = validosMatch ? parseInt(validosMatch[2]) : 0;\nconst emails  = emailMatch   ? parseInt(emailMatch[1])   : 0;\n\n// Ruta fija del CSV generado\nconst csvFile    = 'leads_crm.csv';\nconst csvPath    = `{{ $env.EXPORTS_DIR }}/${csvFile}`;\n\nreturn [{\n  json: {\n    total,\n    validos,\n    pct_whatsapp: pct,\n    con_email: emails,\n    csv_path: csvPath,\n    csv_nombre: csvFile,\n    fecha: new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }),\n    resumen_texto: [\n      `ğŸ“Š *Reporte Leads B2B â€” Salud Mental CDMX*`,\n      `ğŸ“… ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}`,\n      ``,\n      `ğŸ“‹ Total en BD       : ${total}`,\n      `âœ… WhatsApp vÃ¡lidos  : ${validos} (${pct}%)`,\n      `ğŸ“§ Con email         : ${emails}`,\n      ``,\n      `ğŸ“ CSV listo         : ${csvFile}`,\n      ``,\n      `â¡ï¸ Importa el CSV a tu CRM para iniciar outreach.`,\n    ].join('\\n'),\n  }\n}];\n"
      },
      "id": "parse-stats",
      "name": "ğŸ”¢ Parsear Stats",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 320]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "={{ $json.resumen_texto }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "notify-telegram",
      "name": "ğŸ“± Notificar por Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2460, 240],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-cred",
          "name": "Telegram Bot"
        }
      },
      "notesInFlow": true,
      "notes": "Opcional: configura tu bot de Telegram.\nO reemplaza este nodo por Email/Slack."
    },
    {
      "parameters": {
        "fromEmail": "={{ $env.SMTP_FROM }}",
        "toEmail":   "={{ $env.NOTIFY_EMAIL }}",
        "subject":   "âœ… Leads B2B listos â€” {{ $json.validos }} con WhatsApp vÃ¡lido",
        "emailType": "text",
        "message":   "={{ $json.resumen_texto }}"
      },
      "id": "notify-email",
      "name": "ğŸ“§ Notificar por Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [2460, 400],
      "credentials": {
        "smtp": {
          "id": "smtp-cred",
          "name": "SMTP"
        }
      },
      "notesInFlow": true,
      "notes": "Alternativa a Telegram.\nConfigura credenciales SMTP en n8n."
    },
    {
      "parameters": {
        "jsCode": "// Nodo de manejo de error â€” Script 1 fallÃ³\nconst stdout   = $input.first().json.stdout   || '';\nconst stderr   = $input.first().json.stderr   || '';\nconst exitCode = $input.first().json.exitCode;\n\nconsole.error(`[ERROR] Script 1 fallÃ³ con cÃ³digo ${exitCode}`);\nconsole.error('STDOUT:', stdout);\nconsole.error('STDERR:', stderr);\n\nreturn [{\n  json: {\n    error:     true,\n    script:    'extractor_hibrido.py',\n    exitCode,\n    mensaje:   `Script 1 (Extractor) fallÃ³ con cÃ³digo ${exitCode}`,\n    stdout:    stdout.slice(-500),\n    stderr:    stderr.slice(-500),\n    timestamp: new Date().toISOString(),\n  }\n}];\n"
      },
      "id": "error-script1",
      "name": "ğŸ”´ Error Script 1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1020, 600]
    },
    {
      "parameters": {
        "jsCode": "// Nodo de manejo de error â€” Script 2 fallÃ³\nconst stdout   = $input.first().json.stdout   || '';\nconst stderr   = $input.first().json.stderr   || '';\nconst exitCode = $input.first().json.exitCode;\n\nconsole.error(`[ERROR] Script 2 fallÃ³ con cÃ³digo ${exitCode}`);\n\nreturn [{\n  json: {\n    error:     true,\n    script:    'verificar_whatsapp.py',\n    exitCode,\n    mensaje:   `Script 2 (Verificador) fallÃ³ con cÃ³digo ${exitCode}`,\n    stdout:    stdout.slice(-500),\n    stderr:    stderr.slice(-500),\n    timestamp: new Date().toISOString(),\n  }\n}];\n"
      },
      "id": "error-script2",
      "name": "ğŸ”´ Error Script 2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 520]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "ğŸ”´ *Error en pipeline de Leads B2B*\n\n*Script:* `={{ $json.script }}`\n*CÃ³digo:* `={{ $json.exitCode }}`\n*Mensaje:* {{ $json.mensaje }}\n\n*Log:*\n```\n={{ $json.stdout }}\n```",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "notify-error",
      "name": "ğŸš¨ Notificar Error",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1740, 560],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-cred",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ ok: true, mensaje: 'Pipeline iniciado', timestamp: new Date().toISOString() }) }}"
      },
      "id": "webhook-trigger",
      "name": "ğŸŒ Webhook Trigger (n8n â†’ externo)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 720],
      "webhookId": "leads-b2b-trigger",
      "notesInFlow": true,
      "notes": "URL: https://tu-n8n.com/webhook/leads-b2b-trigger\nÃšsala desde Postman, cron externo o tu app."
    }
  ],
  "connections": {
    "â–¶ï¸ Inicio Manual": {
      "main": [[{ "node": "ğŸ“œ Script 1 â€” Extractor de Leads", "type": "main", "index": 0 }]]
    },
    "â° Schedule Semanal (Lunes 6am)": {
      "main": [[{ "node": "ğŸ“œ Script 1 â€” Extractor de Leads", "type": "main", "index": 0 }]]
    },
    "ğŸŒ Webhook Trigger (n8n â†’ externo)": {
      "main": [[{ "node": "ğŸ“œ Script 1 â€” Extractor de Leads", "type": "main", "index": 0 }]]
    },
    "ğŸ“œ Script 1 â€” Extractor de Leads": {
      "main": [[{ "node": "âœ… Â¿Script 1 OK?", "type": "main", "index": 0 }]]
    },
    "âœ… Â¿Script 1 OK?": {
      "main": [
        [{ "node": "ğŸ“œ Script 2 â€” Verificador WhatsApp", "type": "main", "index": 0 }],
        [{ "node": "ğŸ”´ Error Script 1",                  "type": "main", "index": 0 }]
      ]
    },
    "ğŸ“œ Script 2 â€” Verificador WhatsApp": {
      "main": [[{ "node": "âœ… Â¿Script 2 OK?", "type": "main", "index": 0 }]]
    },
    "âœ… Â¿Script 2 OK?": {
      "main": [
        [{ "node": "ğŸ“œ Script 3 â€” Importar a PostgreSQL", "type": "main", "index": 0 }],
        [{ "node": "ğŸ”´ Error Script 2",                   "type": "main", "index": 0 }]
      ]
    },
    "ğŸ“œ Script 3 â€” Importar a PostgreSQL": {
      "main": [[{ "node": "ğŸ“œ Script 3 â€” Exportar CSV", "type": "main", "index": 0 }]]
    },
    "ğŸ“œ Script 3 â€” Exportar CSV": {
      "main": [[{ "node": "ğŸ“Š Script 3 â€” Stats de BD", "type": "main", "index": 0 }]]
    },
    "ğŸ“Š Script 3 â€” Stats de BD": {
      "main": [[{ "node": "ğŸ”¢ Parsear Stats", "type": "main", "index": 0 }]]
    },
    "ğŸ”¢ Parsear Stats": {
      "main": [
        [{ "node": "ğŸ“± Notificar por Telegram", "type": "main", "index": 0 }],
        [{ "node": "ğŸ“§ Notificar por Email",    "type": "main", "index": 0 }]
      ]
    },
    "ğŸ”´ Error Script 1": {
      "main": [[{ "node": "ğŸš¨ Notificar Error", "type": "main", "index": 0 }]]
    },
    "ğŸ”´ Error Script 2": {
      "main": [[{ "node": "ğŸš¨ Notificar Error", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    { "name": "leads-b2b" },
    { "name": "salud-mental" },
    { "name": "cdmx" }
  ],
  "pinData": {},
  "versionId": "1.0.0",
  "meta": {
    "instanceId": "leads-b2b-salud-mental-cdmx"
  }
}